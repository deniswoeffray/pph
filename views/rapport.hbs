<head>
    <base href="/grp13"/>

</head>
<body>

<h1>rapport - {{code}}</h1>
<table>
    {{#each reponses}}
        <tr>
            <td>{{this.Question.Categorie.name}}</td>
            <td>{{this.Question.question}}</td>
            <td>{{this.value}}</td>
            <td>{{this.satisfaction}}</td>
        </tr>
    {{/each}}
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>

<canvas id="myChart" style="width:20%;height:30vh"></canvas>
<script>
    var data = [];
    data.categories = [];

        {{#each reponses}}
        if (data.categories.indexOf("{{this.Question.Categorie.name}}") == -1) {
            data.categories.push("{{this.Question.Categorie.name}}");
        }
        {{/each}}


    //array with all values by categories
    data.categoriesValues = [];
        {{#each reponses}}
            //if the category is empty of values
            if(data.categoriesValues[data.categories.indexOf("{{this.Question.Categorie.name}}")] == undefined)
            {
                //new array for this category
                data.categoriesValues[data.categories.indexOf("{{this.Question.Categorie.name}}")] = [];
            }
            //add the category
            data.categoriesValues[data.categories.indexOf("{{this.Question.Categorie.name}}")].push({{this.value}});
        {{/each}}

    //TODO gérer les non réponses (-2)

    var finalValues = [];

    for(let t of data.categoriesValues)
    {
        var div = 0;
        var number = 0;
        for(let i of t)
        {

            if(i>=0)
            {
                number = number+i;
                div++;
            }
        }
        if(div==0)
        {
            finalValues.push(-1);
        }
        else
        {
            finalValues.push(number/div);
        }
    }

    var colors = [];
    for (let v of finalValues) {
        if (v < 0) {
            colors.push('grey');
        }
        else if (v < 4) {
            colors.push('red');

        }
        else if (v < 7) {
            colors.push('orange');

        }
        else {
            colors.push('green');
        }
    }

    var ctx = document.getElementById("myChart").getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.categories,
            datasets: [{
                label: 'Niveau de participation',
                data: finalValues,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });

    var dataset = myChart.data.datasets[0];
    for (let i = 0; i < dataset.data.length; i++) {
        if (dataset.data[i] < 0) {
            dataset.backgroundColor[i] = "grey";
            dataset.borderColor[i] = "grey";
        }
        else if (dataset.data[i] < 4) {
            dataset.backgroundColor[i] = "red";
            dataset.borderColor[i] = "red";
        }
        else if (dataset.data[i] < 7) {
            dataset.backgroundColor[i] = "orange";
            dataset.borderColor[i] = "orange";
        }
        else {
            dataset.backgroundColor[i] = "green";
            dataset.borderColor[i] = "green";
        }
    }
</script>

</body>